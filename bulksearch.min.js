/*
 https://github.com/nextapps-de/bulksearch
 @version: 0.1.26
 @license: Apache 2.0 Licence
*/
'use strict';(function(r,n,d){var g;(g=d.define)&&g.amd?g([],function(){return n}):(g=d.modules)?g[r.toLowerCase()]=n:"undefined"!==typeof module?module.exports=n:d[r]=n})("BulkSearch",function(r,n){function d(a){this.id=D++;this.init(a||f);Object.defineProperty(this,"index",{get:function(){return this.a}});Object.defineProperty(this,"length",{get:function(){return Object.keys(this.a).length}})}function g(a,b){return new (("int"===a||"integer"===a?Uint32Array:"short"===a?Uint16Array:"float"===a||
"double"===a?Float64Array:"byte"===a?Uint8Array:Array)||Array)(b)}function c(a){return new RegExp(a,"g")}function u(a,b,e){if("undefined"===typeof e){for(e=0;e<b.length;e+=2)a=a.replace(b[e],b[e+1]);return a}return a.replace(b,e)}function E(a,b){a=a.length-b.length;return 0>a?1:0<a?-1:0}function A(a){for(var b="",e="",h="",y=0;y<a.length;y++){var c=a[y];c!==e&&(0<y&&"h"===c?(h="a"===h||"e"===h||"i"===h||"o"===h||"u"===h||"y"===h,"a"!==e&&"e"!==e&&"i"!==e&&"o"!==e&&"u"!==e&&"y"!==e||!h||(b+=c)):b+=
c);h=y===a.length-1?"":a[y+1];e=c}return b}function B(a){var b={},e=a.split(z);a="";for(var h=0;h<e.length;h++){var c=e[h];c&&(this.encode&&(c=this.encode(c)),c&&!b[c]&&(b[c]="1",a+=c))}return a}var f={type:"integer",result:"id",separator:"~",B:!1,v:!1,l:!1,A:!1,cache:!1,encode:!1,w:!1,size:4E3,depth:0},p=[],D=0;d.new=function(a){return new this(a)};d.create=function(a){return d.new(a)};d.addMatcher=function(a){for(var b in a)a.hasOwnProperty(b)&&(p[p.length]=c(b),p[p.length]=a[b])};d.register=function(a,
b){v[a]=b};d.encode=function(a,b){return v[a](b)};d.prototype.init=function(a){a&&(this.type=a.type||this.type||f.type,this.result=a.result||this.result||f.result,this.separator=a.separator||this.separator||f.separator,this.B=a.strict||this.B||f.B,this.A=a.ordered||this.A||f.A,this.v=a.multi||this.v||f.v,this.l="or"===a["boolean"]||this.l||f.l,this.w=a.paging||this.w||f.w,this.cache=a.cache||this.cache||f.cache,this.depth=a.depth||this.depth||f.depth,this.encoder=a.encode&&v[a.encode]||this.encoder||
v[f.encode]||a.encode,this.h={},this.i=a.size||f.size,a.matcher&&(this.c=[],this.addMatcher(a.matcher)));this.C={};this.c||(this.c=[]);this.g=[g(this.type,this.i)];this.a={};this.j={};this.s={};this.b=[""];this.D=0;this.u=!0;this.m=0;this.f=this.cache?new n(3E4,50,!0):!1};d.prototype.encode=function(a){this.encoder&&(a=this.encoder(a));p.length&&(a=u(a,p));this.c.length&&(a=u(a,this.c));return a};d.prototype.add=function(a,b,e){if("string"===typeof b&&b&&(a||0===a))if(this.a[a])this.update(a,b);else if("string"===
typeof e?b=e:b&&(b=B.call(this,b)),b){var h=this.b;e=this.D;var c=this.j[b.length];if(c&&c.length){this.a[a]=c=c.pop();e=c[0];var k=c[1];var d=h[e];h[e]=d.substring(0,k)+b+d.substring(c[2]);this.m-=b.length}else k=h[e].length,k+b.length>this.i&&(b.length>this.i/2&&(this.i=2*b.length),k&&(this.D=++e),k=0,h[e]="",this.g[e]=g(this.type,this.i)),this.a[a]=c=[e,k,0],h[e]+=b+this.separator;if(this.g[e].constructor===Array)for(h=0;h<b.length;h++)this.g[e][k++]=a;else this.g[e].fill(a,k,k+b.length+1),k+=
b.length;c[2]=k;if(this.depth)for(h=this.depth;1<h;h--)a=b.substring(0,h),this.s[a]||(this.s[a]=[]),this.s[a].push(c);this.u=!1}};d.prototype.update=function(a,b){if("string"===typeof b&&(a||0===a)){var e=this.a[a];if(e){var c=b;b&&(b=B.call(this,b));if(!c||b){var d=e[1],k=e[2],t=k-d,m=b.length-t,q=b;for(0<m&&(b="");b.length<t;)b=(b+"                                                  ").substring(0,t);var l=this.b,C=e[0],f=l[C];l[C]=f.substring(0,d)+b+f.substring(k);if(0<m||!c)(b=this.j[t])?b=b.length:
(this.j[t]=[],b=0),this.j[t][b]=e,this.m+=t,this.a[a]=null,c&&this.add(a,c,q);this.u=!1}}}};d.prototype.remove=function(a){this.a[a]&&(this.update(a,""),delete this.a[a],delete this.h[a])};var z=c("[ -/]");d.prototype.search=function(a,b,e){var c=0,d=0;a&&"object"===typeof a&&(e=b,b=a,a=a.query);b&&("function"===typeof b?(e=b,b=1E3):"object"===typeof b&&(b.page&&(d=b.page.split(":"),c=parseInt(d[0],10),d=parseInt(d[1],10)),b.callback&&(e=b.callback,b.callback=!1),b=b.limit));b||(b=1E3);if(e){var k=
this;if(c||d)b={page:c+":"+d,limit:b};r(function(){e(k.search(a,b));k=null},1,"search-"+this.id);return null}if(this.w)var t=c+":"+d,m={current:t,prev:this.C[t]||null,next:null,results:[]},q=m.results;else q=[];if(!a||"string"!==typeof a)return m||q;var l=a;if(!this.u)this.cache&&(this.o="",this.f.reset()),this.u=!0;else if(this.cache){var f=this.f.get(a);if(f)return f}else if(this.o&&-1!==a.indexOf(this.o))return m||q;for(f=0;" "===a[f];)f++;f&&(l=a.substring(f));if(!l)return m||q;l=this.v?l.split(z):
[l];f=l.length;1<f&&l.sort(E);var n=Array(f);for(this.encode&&l[0]&&(l[0]=this.encode(l[0]));c<this.b.length;c++){var g=d,p=0,v=this.b[c];for(d=0;-1!==(p=v.indexOf(l[0],g));){g=this.g[c][p];var w=this.a[g];if(w){var u=w[1];p=w[2];w=!0;if(1<f){u=v.substring(u,p);for(var x=1;x<f;x++)if(l[x])if(this.encode&&!n[x]&&(l[x]=this.encode(l[x]),n[x]=!0),-1===u.indexOf(l[x]))if(this.l)w=!1;else{w=!1;break}else if(this.l){w=!0;break}}if(w&&(this.h[g]?this.h[g]++:this.h[g]=1,q[q.length]=g,b&&q.length===b))break}g=
p+1}if(b&&q.length===b){m&&c<this.b.length&&p+1<this.b[c].length&&(m.next=c+":"+p,this.C[m.next]=t);break}}q.length?this.o="":this.o||(this.o=a);this.cache&&this.f.set(a,m||q);return m||q};d.prototype.addMatcher=function(a){for(var b in a)a.hasOwnProperty(b)&&(this.c[this.c.length]=c(b),this.c[this.c.length]=a[b])};d.prototype.optimize=function(){var a=this.b,b=this.a,c=this.f,d=this.h;this.reset();var f=Object.keys(b);f.sort(function(a,b){a=(d[b]||0)-(d[a]||0);return 0>a?-1:0<a?1:0});for(var k=0;k<
f.length;k++){var g=f[k],m=b[g];m?this.add(g,a[m[0]].substring(m[1],m[2])):delete b[g]}c&&(this.f=c);this.h=d};d.prototype.info=function(){for(var a=this.m,b=Object.keys(this.a).length,c=Object.keys(this.j).length,d=Object.keys(this.s).length,f=0,k=0,g=0;g<this.b.length;g++)k+=this.b[g].length;k&&(a=(100/k*a*100|0)/100,f=this.g[0].byteLength||32*k,f+=2*k+24*(b+c+d));return{id:this.id,length:b,chunks:this.b.length,register:d,depth:this.depth,size:this.i,bytes:f,fragments:c,fragmented:a,status:this.u,
matchers:p.length}};d.prototype.reset=function(){this.destroy();this.init()};d.prototype.destroy=function(){this.cache&&this.f.reset();this.g=this.a=this.j=this.b=this.s=this.f=this.h=this.c=this.C=null};var v={icase:function(a){return a.toLowerCase()},simple:function(){var a=[c("[\u00e0\u00e1\u00e2\u00e3\u00e4\u00e5]"),"a",c("[\u00e8\u00e9\u00ea\u00eb]"),"e",c("[\u00ec\u00ed\u00ee\u00ef]"),"i",c("[\u00f2\u00f3\u00f4\u00f5\u00f6\u0151]"),"o",c("[\u00f9\u00fa\u00fb\u00fc\u0171]"),"u",c("[\u00fd\u0177\u00ff]"),
"y",c("\u00f1"),"n",c("\u00e7"),"c",c("\u00df"),"s",c("[-/]")," ",c("[^a-z0-9 ]"),""];return function(b){return u(b.toLowerCase(),a)}}(),advanced:function(){var a=c(" "),b=[c("ae"),"a",c("ai"),"ei",c("ay"),"ei",c("ey"),"ei",c("oe"),"o",c("ue"),"u",c("ie"),"i",c("sz"),"s",c("zs"),"s",c("sh"),"s",c("ck"),"k",c("cc"),"k",c("dt"),"t",c("ph"),"f",c("ou"),"o",c("uo"),"u"];return function(c,d){if(!c)return c;c=v.simple(c);2<c.length&&(c=u(c,b));d||(c=c.replace(a,""),1<c.length&&(c=A(c)));return c}}(),extra:function(){var a=
[c("p"),"b",c("[sz]"),"c",c("[gq]"),"k",c("[jy]"),"i",c("n"),"m",c("d"),"t",c("[vw]"),"f",c("[aeiouy]"),""];return function(b){if(!b)return b;b=v.advanced(b,!0);if(1<b.length){b=b.split(z);for(var c=0;c<b.length;c++){var d=b[c];1<d.length&&(b[c]=d[0]+u(d.substring(1),a))}b=b.join("");b=A(b)}return b}}()};return d}(function(){var r={};return function(n,d,g){var c=r[g];c&&clearTimeout(c);return r[g]=setTimeout(n,d)}}(),function(){function r(){this.cache={}}r.prototype.reset=function(){this.cache={}};
r.prototype.set=function(n,d){this.cache[n]=d};r.prototype.get=function(n){return this.cache[n]};return r}()),this);
